# 管理者機能仕様書（追補）
# ブロック開示コントロール機能

**対象仕様書：** webapp_spec_third_age.md v1.0  
**追補バージョン：** v1.1  
**追記日：** 2026年2月

---

## 設計思想

ウェブアプリは「自己完結型の入力ツール」ではなく、**ファシリテーターと受講生が同期して進む「ライブ型ワークショップツール」**として設計する。

受講生が単独で先へ進めないよう、管理者（ファシリテーター）がブロックの開示タイミングをコントロールする。これにより：

- 講義とワークが連動する（スライドの説明 → 入力開放 → グループ共有）
- 受講生の進行ペースを揃え、グループ討議のタイミングを作れる
- 「熟考が必要なSTEP」での早押しを防ぐ

---

## 1. ユーザーロールの定義

| ロール | できること |
|--------|-----------|
| **管理者（Admin）** | 全受講生のブロック開示・停止・リセット。進捗の一覧監視 |
| **ファシリテーター（Facilitator）** | ブロック開示・停止のみ（受講生データの閲覧は可、編集不可）|
| **受講生（Participant）** | 開示されたブロックのみ入力・閲覧可 |

---

## 2. ブロック開示の仕組み

### 基本ルール

- 全ブロックはデフォルト「**ロック状態（非表示）**」でスタート
- 管理者がブロックを「**開放**」すると、全受講生の画面に同時に出現する
- 個別開放（特定の受講生だけ先へ進ませる）も可能

### ブロックのステータス定義

| ステータス | 受講生画面の表示 | 入力 |
|-----------|----------------|------|
| **LOCKED** | 表示なし（存在も見えない） | 不可 |
| **PREVIEW** | タイトルと概要のみ見える（グレーアウト）| 不可 |
| **OPEN** | フル表示 | 可 |
| **CLOSED** | 表示されるが入力欄がグレーアウト | 不可（保存済みデータは見える） |

### ブロック開示フロー（標準）

```
管理者がBlock 0を OPEN
        ↓
受講生：オンボーディング完了
        ↓
管理者が「Block 1 を全員に開放」ボタンを押す
        ↓
全受講生の画面にBlock 1が出現（リアルタイム）
        ↓
受講生：Block 1 の入力を進める（各自のペースで）
        ↓
管理者の画面に「完了人数 〇/〇名」が表示される
        ↓
管理者が「次へ進む」ボタンで Block 2 を開放
        ↓
（繰り返し）
```

---

## 3. 管理者ダッシュボード

### [A] メイン画面：進捗一覧

| 表示内容 | 詳細 |
|----------|------|
| 受講生リスト | 名前・現在のブロック・最終アクティブ時刻 |
| ブロック別完了率 | 「Block 1：18/20名完了（90%）」などをバー表示 |
| 現在の開放ブロック | ハイライト表示 |
| アラート | 長時間未操作の受講生を黄色でマーク |

### [B] ブロックコントロールパネル

```
[Block 0] オンボーディング    [OPEN ✓]  ──────────────
[Block 1] 500時間の棚卸し     [OPEN ✓]  18/20名完了
[Block 2] 4つのワークの仕分け  [OPEN ✓]  12/20名完了  ← 現在地
[Block 3] 10年後のポートフォリオ [LOCKED]  [▶ 開放する]
[Block 4] As-Is/To-Be         [LOCKED]  [▶ 開放する]
[Block 5] 4つの資本の監査     [LOCKED]  [▶ 開放する]
[Block 6] 資本循環の構造化    [LOCKED]  [▶ 開放する]
[Block 7] 5年間の移行計画     [LOCKED]  [▶ 開放する]
[Block 8] 経営計画書の出力    [LOCKED]  [▶ 開放する]
```

各ブロックの操作ボタン：
- **▶ 開放する**：全受講生に一斉開放
- **⏸ 停止する**：入力を一時ロック（グループ討議への誘導時）
- **↩ 個別開放**：特定の受講生だけ開放（遅れている受講生への対応）
- **🔄 リセット**：入力データを消去（管理者権限のみ）

### [C] 個別受講生モニタリング

- 受講生名をクリックすると詳細画面へ
- 入力内容をリアルタイムで閲覧（読み取り専用）
- ミッチーとの対話ログも確認可能
- 「この受講生だけ Block 3 を先行開放する」などの個別制御

### [D] タイムコントロール（オプション）

研修のタイムテーブルに合わせて、**ブロック開放を時刻指定で予約**できる機能：

| 設定 | 例 |
|------|----|
| 開放予約時刻 | 「10:30 に Block 2 を自動開放」|
| 制限時間設定 | 「Block 1 の入力時間は 20分」→ タイマー表示 |
| 自動クローズ | 「制限時間終了後に自動CLOSED」|

---

## 4. 受講生側の表示

### ロック中のブロックの見せ方

```
╔══════════════════════════════════╗
║  🔒  STEP 3                     ║
║  10年後のポートフォリオ設計       ║
║                                  ║
║  ファシリテーターが開放するまで   ║
║  お待ちください                  ║
║                                  ║
║  ◉ 現在 STEP 2 を進めています   ║
╚══════════════════════════════════╝
```

- ロック中のSTEPはタイトルと進行状況メッセージのみ表示（PREVIEW状態）
- ミッチーが「次のSTEPまで、ここまでの内容を振り返ってみましょう」と促す

### 停止（CLOSED）時の表示

- 現在のブロックが突然ロックされた場合、ミッチーが「少し立ち止まって、グループで共有しましょう」とアナウンス
- 入力済みの内容は見える・保存済み

### タイマー表示（制限時間設定時）

```
⏱ この入力の残り時間：  14:32
```

- 残り3分を切ると赤くなる
- タイムアップ時にミッチーが「時間です。ここまでで大丈夫です。」とアナウンス

---

## 5. ファシリテーターの手順書（運用フロー）

研修当日の標準的な操作の流れ：

```
【研修開始前】
  ├── 管理者ダッシュボードにログイン
  ├── 受講生の登録確認（20名全員分）
  └── Block 0 のみ OPEN に設定しておく

【DAY 1 開始】
  ├── 「では、画面を開いてください」
  │    → 受講生：オンボーディング開始
  ├── スライドでSTEP 1の講義（約15分）
  │    → 管理者：Block 1 を OPEN
  ├── 受講生：Block 1 入力（約20分）
  │    → 管理者：進捗一覧で完了状況を確認
  │    → 遅れている受講生には個別サポート
  ├── 「では画面から離れて、グループで共有しましょう」
  │    → 管理者：Block 1 を CLOSED（入力停止）
  ├── グループ共有（約10分）
  ├── スライドでSTEP 2の講義
  │    → 管理者：Block 2 を OPEN
  └── （繰り返し）

【DAY 1 終了時】
  ├── 管理者：Block 4 完了後、Block 5以降を全員 LOCKED のまま終了
  └── 「明日また続きをやります。データは保存されています。」

【DAY 2 開始】
  ├── 受講生：前日のデータを確認（Block 4 まで CLOSED で閲覧可）
  └── 管理者：Block 5 を OPEN してスタート
```

---

## 6. 技術要件（追補）

### リアルタイム同期
- **WebSocket（Socket.io）** を使用してブロック開放を全受講生にリアルタイム配信
- 受講生の入力完了ステータスも管理者画面にリアルタイム反映

### 権限管理
- JWT に `role: admin | facilitator | participant` を含める
- ブロック開放 API は `admin / facilitator` ロールのみ実行可能
- 個別モニタリングは `admin` のみ

### データベース追加テーブル

```sql
-- ブロック開示状態管理
CREATE TABLE block_status (
  session_id    VARCHAR,   -- 研修セッションID
  block_id      VARCHAR,   -- block_0 〜 block_8
  status        ENUM('LOCKED', 'PREVIEW', 'OPEN', 'CLOSED'),
  opened_at     TIMESTAMP,
  opened_by     VARCHAR,   -- 管理者ID
  auto_close_at TIMESTAMP  -- タイマー設定時
);

-- 個別受講生の開示状態（個別開放用）
CREATE TABLE participant_block_override (
  user_id    VARCHAR,
  block_id   VARCHAR,
  status     ENUM('LOCKED', 'OPEN'),
  updated_at TIMESTAMP
);
```

---

*本追補仕様書は webapp_spec_third_age.md v1.0 と合わせて使用してください。*  
*Claude Code への引き渡し時は両方のドキュメントをセットで渡してください。*
